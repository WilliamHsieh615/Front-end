<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3C商城</title>

    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.0.2/css/bootstrap.min.css">
    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.13.1/font/bootstrap-icons.min.css">


</head>

<body style="background: #f2f2f2f2;">

    <div id="app" class="container py-4">
        <div class="row">
            <!-- 商品列表區 -->
            <div class="col-md-8">
                <h2 class="mb-3">商品列表</h2>
                <div class="row">
                    <div class="col-md-4 mb-4" v-for="(product, i) in products" :key="i">
                        <div class="card h-100">
                            <img :src="product.imageUrl" :alt="product.name" class="card-img-top"
                                style="height: 150px; object-fit: cover;">
                            <div class="card-body"
                                style="display: flex; flex-direction: column; justify-content: space-between;">
                                <h5 class="card-title">{{ product.name }}</h5>
                                <p class="card-text">{{ product.decription }}</p>
                                <p class="fw-bold text-primary">$ {{ product.price }}</p>
                                <button class="btn btn-success w-100" @click="addToCart(product)"> 加入購物車 </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 購物車區 -->
            <div class="col-md-4">
                <h2 class="mb-3">購物車</h2>
                <p v-if="cart.length == 0">購物車是空的</p>
                <template v-else>
                    <ul class="list-group mb-3" v-for="(item, i) in cart" :key="i">
                        <li class="list-group-item d-flex align-items-center gap-3 flex-wrap">
                            <img :src="item.productItem.imageUrl" :alt="item.productItem.name" style="width:100px; height:auto; object-fit:cover;">
                            <div style="width: 50%;" class="d-flex flex-column gap-2">
                                <h6 class="my-0">{{ item.productItem.name }}</h6>
                                <div class="d-flex gap-2 align-items-center">
                                    <button class="btn btn-sm btn-outline-success" @click="decrease(item)" :disabled="item.count === 1"><i class="bi bi-dash"></i></button>
                                    <span>{{ item.count }}</span>
                                    <button class="btn btn-sm btn-outline-success" @click="increase(item)"><i class="bi bi-plus"></i></button>
                                </div>
                                <p class="text-muted my-0">$ {{ item.subtotal }}</p>
                            </div>
                            <div class="ms-auto">
                                <button class="btn btn-sm btn-outline-danger" @click="removeProduct(item, i)"><i
                                        class="bi bi-trash3-fill"></i></button>
                            </div>
                        </li>
                    </ul>
                    <p class="fs-5 text-end">總金額 $ {{ totalPrice }}</p>
                    <button type="submit" class="btn btn-success w-100" @click="checkout">結帳</button>
                </template>
                
            </div>
        </div>

        <!-- 通知元件 -->
        <div class="position-fixed top-0 end-0 p-3" style="z-index: 1050">
            <div class="toast show align-items-center text-white bg-success border-0" style="opacity: 0.9;" v-for="(message, i) in toasts" :key="i">
                <div class="d-flex mb-2">
                    <div class="toast-body">{{ message }}</div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" @click="toasts.splice(i, 1)"></button>
                </div>
            </div>
        </div>
    </div>

    <script>

        const { createApp, ref, onMounted, computed } = Vue;

        createApp({
            setup() {

                const products = ref([]);
                const cart = ref([]);
                const toasts = ref([])

                const addToCart = (product) => {
                    let found = false;

                    cart.value.forEach(item => {
                        if (item.productItem === product) {
                            item.count++;
                            item.subtotal = item.count * item.productItem.price;
                            found = true;
                        }
                    });

                    if (!found) {
                        cart.value.push({
                            productItem: product,
                            count: 1,
                            subtotal: product.price
                        });
                    }

                    const message = `您已將 ${product.name} 加入購物車`;
                    toasts.value.push(message);

                    setTimeout(() => {
                        toasts.value.shift();
                    }, 3000);

                }

                const increase = (item) => {
                    item.count++;
                    item.subtotal = item.count * item.productItem.price;
                };

                const decrease = (item) => {
                    if (item.count > 1){
                        item.count--;
                        item.subtotal = item.count * item.productItem.price;
                    } 
                };

                const removeProduct = (item, i) => {
                    cart.value.splice(i, 1);

                    const message = `您已將 ${item.productItem.name} 移除購物車`;
                    toasts.value.push(message);

                    setTimeout(() => {
                        toasts.value.shift();
                    }, 3000);
                }

                const totalPrice = computed(() => {

                    let total = 0

                    cart.value.forEach(item => {
                        total += item.subtotal
                    })

                    return total
                });

                const checkout = () => {
                    alert("結帳成功！！");
                    cart.value = [];
                }

                onMounted(() => {

                    axios.get("./product.json")
                        .then(result => {
                            console.log(result.data);
                            products.value = result.data;
                        }).catch(error => {
                            console.log("no data", error);
                        });

                });

                return { products, addToCart, cart, removeProduct, totalPrice, toasts, increase, decrease,  checkout};
            }
        }).mount('#app');

    </script>

    <!-- https://chalk-freedom-ec6.notion.site/2516ab47eb488001b0dff7d3ef5bb719 -->

</body>

</html>